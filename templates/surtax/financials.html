{% extends "surtax/base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Financial Summary</h2>
            <p class="text-gray-500">Marion County FY 2024 Revenues & Expenditures - Imported from Excel</p>
        </div>
        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export Report
        </button>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
            <p class="text-sm font-medium opacity-90">Total Revenue</p>
            <p class="text-3xl font-bold mt-2">${{ '{:,.0f}'.format(total_revenue) }}</p>
            <p class="text-xs opacity-75 mt-1">FY 2024</p>
        </div>
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
            <p class="text-sm font-medium opacity-90">Total Expenditure</p>
            <p class="text-3xl font-bold mt-2">${{ '{:,.0f}'.format(total_expenditure) }}</p>
            <p class="text-xs opacity-75 mt-1">FY 2024</p>
        </div>
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
            <p class="text-sm font-medium opacity-90">Net Position</p>
            <p class="text-3xl font-bold mt-2">${{ '{:,.0f}'.format(net_position) }}</p>
            <p class="text-xs opacity-75 mt-1">{{ '{:.1f}'.format(budget_balance) }}% balance</p>
        </div>
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <p class="text-sm font-medium opacity-90">Budget Health</p>
            <p class="text-3xl font-bold mt-2">{{ '{:.1f}'.format((net_position/total_revenue*100) if total_revenue > 0 else 0) }}%</p>
            <p class="text-xs opacity-75 mt-1">Surplus ratio</p>
        </div>
    </div>

    <!-- Top Categories -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Top Revenue Sources -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Top 10 Revenue Sources</h3>
            <div class="space-y-2">
                {% for rev in top_revenues %}
                <div class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-50">
                    <span class="text-sm text-gray-700 flex-1">{{ rev.account_name[:45] }}</span>
                    <span class="text-sm font-bold text-green-600 ml-4">${{ '{:,.0f}'.format(rev.total_amount) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Top Expenditure Categories -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Top 10 Expenditure Categories</h3>
            <div class="space-y-2">
                {% for exp in top_expenditures %}
                <div class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-50">
                    <span class="text-sm text-gray-700 flex-1">{{ exp.account_name[:45] }}</span>
                    <span class="text-sm font-bold text-red-600 ml-4">${{ '{:,.0f}'.format(exp.total_amount) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue by Fund Type</h3>
            <canvas id="revenueChart" height="250"></canvas>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Expenditure by Fund Type</h3>
            <canvas id="expenditureChart" height="250"></canvas>
        </div>
    </div>

    <!-- Comparison Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue vs Expenditure by Fund</h3>
        <canvas id="comparisonChart" height="100"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#6366f1'];

// Revenue Chart
new Chart(document.getElementById('revenueChart'), {
    type: 'doughnut',
    data: {
        labels: ['General', 'Special Revenue', 'Debt Service', 'Capital', 'Enterprise', 'Internal'],
        datasets: [{
            data: [
                {{ rev_by_fund.general|default(0) }},
                {{ rev_by_fund.special_revenue|default(0) }},
                {{ rev_by_fund.debt_service|default(0) }},
                {{ rev_by_fund.capital_projects|default(0) }},
                {{ rev_by_fund.enterprise|default(0) }},
                {{ rev_by_fund.internal_service|default(0) }}
            ],
            backgroundColor: colors
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: (ctx) => ctx.label + ': $' + ctx.parsed.toLocaleString()
                }
            }
        }
    }
});

// Expenditure Chart
new Chart(document.getElementById('expenditureChart'), {
    type: 'doughnut',
    data: {
        labels: ['General', 'Special Revenue', 'Debt Service', 'Capital', 'Enterprise', 'Internal'],
        datasets: [{
            data: [
                {{ exp_by_fund.general|default(0) }},
                {{ exp_by_fund.special_revenue|default(0) }},
                {{ exp_by_fund.debt_service|default(0) }},
                {{ exp_by_fund.capital_projects|default(0) }},
                {{ exp_by_fund.enterprise|default(0) }},
                {{ exp_by_fund.internal_service|default(0) }}
            ],
            backgroundColor: colors
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: (ctx) => ctx.label + ': $' + ctx.parsed.toLocaleString()
                }
            }
        }
    }
});

// Comparison Chart
new Chart(document.getElementById('comparisonChart'), {
    type: 'bar',
    data: {
        labels: ['General', 'Special Revenue', 'Debt Service', 'Capital', 'Enterprise', 'Internal'],
        datasets: [{
            label: 'Revenue',
            data: [
                {{ rev_by_fund.general|default(0) }},
                {{ rev_by_fund.special_revenue|default(0) }},
                {{ rev_by_fund.debt_service|default(0) }},
                {{ rev_by_fund.capital_projects|default(0) }},
                {{ rev_by_fund.enterprise|default(0) }},
                {{ rev_by_fund.internal_service|default(0) }}
            ],
            backgroundColor: '#10b981'
        }, {
            label: 'Expenditure',
            data: [
                {{ exp_by_fund.general|default(0) }},
                {{ exp_by_fund.special_revenue|default(0) }},
                {{ exp_by_fund.debt_service|default(0) }},
                {{ exp_by_fund.capital_projects|default(0) }},
                {{ exp_by_fund.enterprise|default(0) }},
                {{ exp_by_fund.internal_service|default(0) }}
            ],
            backgroundColor: '#ef4444'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'top' },
            tooltip: {
                callbacks: {
                    label: (ctx) => ctx.dataset.label + ': $' + ctx.parsed.y.toLocaleString()
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: (val) => '$' + (val/1000000).toFixed(0) + 'M'
                }
            }
        }
    }
});
</script>
{% endblock %}
